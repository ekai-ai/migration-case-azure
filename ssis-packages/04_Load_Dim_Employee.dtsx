<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationName="Microsoft.Package"
  DTS:DTSID="{PKG04-DIM-EMP-0001}"
  DTS:ObjectName="04_Load_Dim_Employee"
  DTS:PackageType="5">
  <DTS:Property DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:ConnectionManagers>
    <DTS:ConnectionManager DTS:refId="Package.ConnectionManagers[NorthwindDW]" DTS:CreationName="OLEDB" DTS:DTSID="{CONN-DW-0004}" DTS:ObjectName="NorthwindDW">
      <DTS:ObjectData>
        <DTS:ConnectionManager DTS:ConnectionString="Data Source=localhost;Initial Catalog=Northwind;Provider=MSOLEDBSQL;Integrated Security=SSPI;" />
      </DTS:ObjectData>
    </DTS:ConnectionManager>
  </DTS:ConnectionManagers>
  <DTS:Variables>
    <DTS:Variable DTS:CreationName="" DTS:DTSID="{VAR-EMP-001}" DTS:Namespace="User" DTS:ObjectName="RowsInserted">
      <DTS:VariableValue DTS:DataType="3">0</DTS:VariableValue>
    </DTS:Variable>
  </DTS:Variables>
  <DTS:Executables>
    <DTS:Executable DTS:refId="Package\Log Start" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOG-EMP1}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Log Start">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0004}" SQLTask:SqlStatementSource="INSERT INTO dbo.ETL_Log (PackageName, TaskName, StartTime, Status) VALUES ('04_Load_Dim_Employee', 'Full Load', GETDATE(), 'Running')" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Truncate Dim_Employee" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-TRUNC-EMP}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Truncate Dim_Employee">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0004}" SQLTask:SqlStatementSource="DELETE FROM dbo.Dim_Employee" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Load Employee Dimension" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOAD-EMP}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Load Employee Dimension" DTS:Description="Load employees with hierarchy">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0004}" SQLTask:SqlStatementSource="
INSERT INTO dbo.Dim_Employee (
    EmployeeID, FullName, FirstName, LastName, Title, TitleOfCourtesy,
    BirthDate, HireDate, Address, City, Region, PostalCode, Country,
    HomePhone, Extension, ReportsToID, ReportsToName, IsManager,
    ManagementLevel, YearsOfService, AgeAtHire, TerritoryCount,
    EffectiveDate, IsCurrent
)
SELECT
    e.EmployeeID,
    e.LastName + ', ' + e.FirstName AS FullName,
    e.FirstName,
    e.LastName,
    e.Title,
    e.TitleOfCourtesy,
    e.BirthDate,
    e.HireDate,
    e.Address,
    e.City,
    e.Region,
    e.PostalCode,
    e.Country,
    e.HomePhone,
    e.Extension,
    e.ReportsTo AS ReportsToID,
    m.LastName + ', ' + m.FirstName AS ReportsToName,
    -- IsManager: has direct reports
    CASE WHEN EXISTS (SELECT 1 FROM Employees e2 WHERE e2.ReportsTo = e.EmployeeID) THEN 1 ELSE 0 END AS IsManager,
    -- ManagementLevel
    CASE
        WHEN e.ReportsTo IS NULL THEN 2
        WHEN EXISTS (SELECT 1 FROM Employees e2 WHERE e2.ReportsTo = e.EmployeeID) THEN 1
        ELSE 0
    END AS ManagementLevel,
    -- YearsOfService
    DATEDIFF(YEAR, e.HireDate, GETDATE()) AS YearsOfService,
    -- AgeAtHire
    DATEDIFF(YEAR, e.BirthDate, e.HireDate) AS AgeAtHire,
    -- TerritoryCount
    (SELECT COUNT(*) FROM EmployeeTerritories et WHERE et.EmployeeID = e.EmployeeID) AS TerritoryCount,
    CAST(GETDATE() AS DATE) AS EffectiveDate,
    1 AS IsCurrent
FROM Employees e
LEFT JOIN Employees m ON e.ReportsTo = m.EmployeeID;
" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Get Row Count" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-CNT-EMP}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Get Row Count">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0004}" SQLTask:SqlStatementSource="SELECT COUNT(*) FROM dbo.Dim_Employee" SQLTask:ResultType="ResultSetType_SingleRow" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask">
          <SQLTask:ResultBinding SQLTask:ResultName="0" SQLTask:DtsVariableName="User::RowsInserted" />
        </SQLTask:SqlTaskData>
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Log Success" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOG-EMP2}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Log Success">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0004}" SQLTask:SqlStatementSource="UPDATE dbo.ETL_Log SET EndTime = GETDATE(), Status = 'Succeeded', RowsInserted = ? WHERE PackageName = '04_Load_Dim_Employee' AND Status = 'Running'" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask">
          <SQLTask:ParameterBinding SQLTask:ParameterName="0" SQLTask:DtsVariableName="User::RowsInserted" SQLTask:ParameterDirection="Input" SQLTask:DataType="3" />
        </SQLTask:SqlTaskData>
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Log to Truncate]" DTS:CreationName="" DTS:DTSID="{PC-0004-0001}" DTS:From="Package\Log Start" DTS:LogicalAnd="True" DTS:ObjectName="Log to Truncate" DTS:To="Package\Truncate Dim_Employee" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Truncate to Load]" DTS:CreationName="" DTS:DTSID="{PC-0004-0002}" DTS:From="Package\Truncate Dim_Employee" DTS:LogicalAnd="True" DTS:ObjectName="Truncate to Load" DTS:To="Package\Load Employee Dimension" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Load to Count]" DTS:CreationName="" DTS:DTSID="{PC-0004-0003}" DTS:From="Package\Load Employee Dimension" DTS:LogicalAnd="True" DTS:ObjectName="Load to Count" DTS:To="Package\Get Row Count" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Count to Log]" DTS:CreationName="" DTS:DTSID="{PC-0004-0004}" DTS:From="Package\Get Row Count" DTS:LogicalAnd="True" DTS:ObjectName="Count to Log" DTS:To="Package\Log Success" />
  </DTS:PrecedenceConstraints>
</DTS:Executable>

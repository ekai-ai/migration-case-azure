<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationName="Microsoft.Package"
  DTS:DTSID="{PKG02-DIM-CUST-0001}"
  DTS:ObjectName="02_Load_Dim_Customer"
  DTS:PackageType="5">
  <DTS:Property DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:ConnectionManagers>
    <DTS:ConnectionManager DTS:refId="Package.ConnectionManagers[NorthwindDW]" DTS:CreationName="OLEDB" DTS:DTSID="{CONN-DW-0002}" DTS:ObjectName="NorthwindDW">
      <DTS:ObjectData>
        <DTS:ConnectionManager DTS:ConnectionString="Data Source=localhost;Initial Catalog=Northwind;Provider=MSOLEDBSQL;Integrated Security=SSPI;" />
      </DTS:ObjectData>
    </DTS:ConnectionManager>
  </DTS:ConnectionManagers>
  <DTS:Variables>
    <DTS:Variable DTS:CreationName="" DTS:DTSID="{VAR-CUS-001}" DTS:Namespace="User" DTS:ObjectName="RowsInserted">
      <DTS:VariableValue DTS:DataType="3">0</DTS:VariableValue>
    </DTS:Variable>
  </DTS:Variables>
  <DTS:Executables>
    <DTS:Executable DTS:refId="Package\Log Start" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOG-CUS1}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Log Start">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0002}" SQLTask:SqlStatementSource="INSERT INTO dbo.ETL_Log (PackageName, TaskName, StartTime, Status) VALUES ('02_Load_Dim_Customer', 'Full Load', GETDATE(), 'Running')" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Load Customer Dimension" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOAD-CUS}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Load Customer Dimension" DTS:Description="Load customers with derived attributes using SCD Type 2 logic">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0002}" SQLTask:SqlStatementSource="
-- Expire changed records (SCD Type 2)
UPDATE dc SET
    dc.ExpirationDate = CAST(GETDATE() AS DATE),
    dc.IsCurrent = 0
FROM dbo.Dim_Customer dc
INNER JOIN Customers c ON dc.CustomerID = c.CustomerID
WHERE dc.IsCurrent = 1
AND (dc.CompanyName != c.CompanyName OR dc.ContactName != ISNULL(c.ContactName,'')
     OR dc.Address != ISNULL(c.Address,'') OR dc.City != ISNULL(c.City,''));

-- Insert new and changed customers
INSERT INTO dbo.Dim_Customer (
    CustomerID, CompanyName, ContactName, ContactTitle, Address, City, Region,
    PostalCode, Country, Phone, Fax, CustomerSegment, GeographyRegion,
    FirstOrderDate, LastOrderDate, TotalOrders, TotalRevenue, AvgOrderValue,
    CustomerLifetimeValue, DaysSinceLastOrder, EffectiveDate, IsCurrent
)
SELECT
    c.CustomerID,
    c.CompanyName,
    c.ContactName,
    c.ContactTitle,
    c.Address,
    c.City,
    c.Region,
    c.PostalCode,
    c.Country,
    c.Phone,
    c.Fax,
    -- CustomerSegment based on order history
    CASE
        WHEN ISNULL(stats.TotalRevenue, 0) > 10000 THEN 'High Value'
        WHEN ISNULL(stats.TotalRevenue, 0) > 5000 THEN 'Medium'
        ELSE 'Low'
    END AS CustomerSegment,
    -- GeographyRegion
    CASE
        WHEN c.Country IN ('USA', 'Canada', 'Mexico', 'Brazil', 'Venezuela', 'Argentina') THEN 'Americas'
        WHEN c.Country IN ('UK', 'Germany', 'France', 'Spain', 'Italy', 'Sweden', 'Finland', 'Norway', 'Denmark', 'Belgium', 'Switzerland', 'Austria', 'Portugal', 'Ireland', 'Poland') THEN 'Europe'
        ELSE 'Other'
    END AS GeographyRegion,
    stats.FirstOrderDate,
    stats.LastOrderDate,
    ISNULL(stats.TotalOrders, 0) AS TotalOrders,
    ISNULL(stats.TotalRevenue, 0) AS TotalRevenue,
    ISNULL(stats.AvgOrderValue, 0) AS AvgOrderValue,
    ISNULL(stats.TotalRevenue, 0) * 1.5 AS CustomerLifetimeValue,
    DATEDIFF(DAY, stats.LastOrderDate, GETDATE()) AS DaysSinceLastOrder,
    CAST(GETDATE() AS DATE) AS EffectiveDate,
    1 AS IsCurrent
FROM Customers c
LEFT JOIN (
    SELECT
        o.CustomerID,
        MIN(o.OrderDate) AS FirstOrderDate,
        MAX(o.OrderDate) AS LastOrderDate,
        COUNT(DISTINCT o.OrderID) AS TotalOrders,
        SUM(od.UnitPrice * od.Quantity * (1 - od.Discount)) AS TotalRevenue,
        AVG(od.UnitPrice * od.Quantity * (1 - od.Discount)) AS AvgOrderValue
    FROM Orders o
    INNER JOIN [Order Details] od ON o.OrderID = od.OrderID
    GROUP BY o.CustomerID
) stats ON c.CustomerID = stats.CustomerID
WHERE NOT EXISTS (
    SELECT 1 FROM dbo.Dim_Customer dc
    WHERE dc.CustomerID = c.CustomerID AND dc.IsCurrent = 1
);
" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Get Row Count" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-CNT-CUS}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Get Row Count">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0002}" SQLTask:SqlStatementSource="SELECT COUNT(*) FROM dbo.Dim_Customer WHERE IsCurrent = 1" SQLTask:ResultType="ResultSetType_SingleRow" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask">
          <SQLTask:ResultBinding SQLTask:ResultName="0" SQLTask:DtsVariableName="User::RowsInserted" />
        </SQLTask:SqlTaskData>
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Log Success" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOG-CUS2}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Log Success">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0002}" SQLTask:SqlStatementSource="UPDATE dbo.ETL_Log SET EndTime = GETDATE(), Status = 'Succeeded', RowsInserted = ? WHERE PackageName = '02_Load_Dim_Customer' AND Status = 'Running'" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask">
          <SQLTask:ParameterBinding SQLTask:ParameterName="0" SQLTask:DtsVariableName="User::RowsInserted" SQLTask:ParameterDirection="Input" SQLTask:DataType="3" />
        </SQLTask:SqlTaskData>
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Log to Load]" DTS:CreationName="" DTS:DTSID="{PC-0002-0001}" DTS:From="Package\Log Start" DTS:LogicalAnd="True" DTS:ObjectName="Log to Load" DTS:To="Package\Load Customer Dimension" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Load to Count]" DTS:CreationName="" DTS:DTSID="{PC-0002-0002}" DTS:From="Package\Load Customer Dimension" DTS:LogicalAnd="True" DTS:ObjectName="Load to Count" DTS:To="Package\Get Row Count" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Count to Log]" DTS:CreationName="" DTS:DTSID="{PC-0002-0003}" DTS:From="Package\Get Row Count" DTS:LogicalAnd="True" DTS:ObjectName="Count to Log" DTS:To="Package\Log Success" />
  </DTS:PrecedenceConstraints>
</DTS:Executable>

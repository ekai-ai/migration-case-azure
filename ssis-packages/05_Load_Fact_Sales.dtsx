<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationName="Microsoft.Package"
  DTS:DTSID="{PKG05-FACT-SALES-0001}"
  DTS:ObjectName="05_Load_Fact_Sales"
  DTS:PackageType="5">
  <DTS:Property DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:ConnectionManagers>
    <DTS:ConnectionManager DTS:refId="Package.ConnectionManagers[NorthwindDW]" DTS:CreationName="OLEDB" DTS:DTSID="{CONN-DW-0005}" DTS:ObjectName="NorthwindDW">
      <DTS:ObjectData>
        <DTS:ConnectionManager DTS:ConnectionString="Data Source=localhost;Initial Catalog=Northwind;Provider=MSOLEDBSQL;Integrated Security=SSPI;" />
      </DTS:ObjectData>
    </DTS:ConnectionManager>
  </DTS:ConnectionManagers>
  <DTS:Variables>
    <DTS:Variable DTS:CreationName="" DTS:DTSID="{VAR-FACT-001}" DTS:Namespace="User" DTS:ObjectName="RowsInserted">
      <DTS:VariableValue DTS:DataType="3">0</DTS:VariableValue>
    </DTS:Variable>
  </DTS:Variables>
  <DTS:Executables>
    <DTS:Executable DTS:refId="Package\Log Start" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOG-FACT1}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Log Start">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0005}" SQLTask:SqlStatementSource="INSERT INTO dbo.ETL_Log (PackageName, TaskName, StartTime, Status) VALUES ('05_Load_Fact_Sales', 'Full Load', GETDATE(), 'Running')" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Truncate Fact_Sales" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-TRUNC-FACT}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Truncate Fact_Sales">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0005}" SQLTask:SqlStatementSource="TRUNCATE TABLE dbo.Fact_Sales" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Load Fact Sales" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOAD-FACT}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Load Fact Sales" DTS:Description="Load fact table with dimension lookups">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0005}" SQLTask:SqlStatementSource="
INSERT INTO dbo.Fact_Sales (
    OrderID, DateKey, CustomerKey, ProductKey, EmployeeKey, OrderLineNumber,
    Quantity, UnitPrice, Discount, GrossAmount, DiscountAmount, NetAmount,
    OrderFreight, FreightAllocation, OrderDate, RequiredDate, ShippedDate,
    DaysToShip, DaysLate, IsLateShipment
)
SELECT
    o.OrderID,
    -- DateKey lookup
    CONVERT(INT, CONVERT(VARCHAR(8), o.OrderDate, 112)) AS DateKey,
    -- CustomerKey lookup
    dc.CustomerKey,
    -- ProductKey lookup
    dp.ProductKey,
    -- EmployeeKey lookup
    de.EmployeeKey,
    -- OrderLineNumber
    ROW_NUMBER() OVER (PARTITION BY o.OrderID ORDER BY od.ProductID) AS OrderLineNumber,
    -- Measures
    od.Quantity,
    od.UnitPrice,
    od.Discount,
    -- Calculated measures
    od.UnitPrice * od.Quantity AS GrossAmount,
    od.UnitPrice * od.Quantity * od.Discount AS DiscountAmount,
    od.UnitPrice * od.Quantity * (1 - od.Discount) AS NetAmount,
    -- Freight allocation
    o.Freight AS OrderFreight,
    o.Freight / NULLIF((SELECT COUNT(*) FROM [Order Details] od2 WHERE od2.OrderID = o.OrderID), 0) AS FreightAllocation,
    -- Dates
    o.OrderDate,
    o.RequiredDate,
    o.ShippedDate,
    -- Shipping metrics
    DATEDIFF(DAY, o.OrderDate, o.ShippedDate) AS DaysToShip,
    CASE WHEN o.ShippedDate > o.RequiredDate THEN DATEDIFF(DAY, o.RequiredDate, o.ShippedDate) ELSE 0 END AS DaysLate,
    CASE WHEN o.ShippedDate > o.RequiredDate THEN 1 ELSE 0 END AS IsLateShipment
FROM Orders o
INNER JOIN [Order Details] od ON o.OrderID = od.OrderID
INNER JOIN dbo.Dim_Customer dc ON o.CustomerID = dc.CustomerID AND dc.IsCurrent = 1
INNER JOIN dbo.Dim_Product dp ON od.ProductID = dp.ProductID AND dp.IsCurrent = 1
INNER JOIN dbo.Dim_Employee de ON o.EmployeeID = de.EmployeeID AND de.IsCurrent = 1;
" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Get Row Count" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-CNT-FACT}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Get Row Count">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0005}" SQLTask:SqlStatementSource="SELECT COUNT(*) FROM dbo.Fact_Sales" SQLTask:ResultType="ResultSetType_SingleRow" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask">
          <SQLTask:ResultBinding SQLTask:ResultName="0" SQLTask:DtsVariableName="User::RowsInserted" />
        </SQLTask:SqlTaskData>
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Log Success" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOG-FACT2}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Log Success">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0005}" SQLTask:SqlStatementSource="UPDATE dbo.ETL_Log SET EndTime = GETDATE(), Status = 'Succeeded', RowsInserted = ? WHERE PackageName = '05_Load_Fact_Sales' AND Status = 'Running'" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask">
          <SQLTask:ParameterBinding SQLTask:ParameterName="0" SQLTask:DtsVariableName="User::RowsInserted" SQLTask:ParameterDirection="Input" SQLTask:DataType="3" />
        </SQLTask:SqlTaskData>
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Log to Truncate]" DTS:CreationName="" DTS:DTSID="{PC-0005-0001}" DTS:From="Package\Log Start" DTS:LogicalAnd="True" DTS:ObjectName="Log to Truncate" DTS:To="Package\Truncate Fact_Sales" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Truncate to Load]" DTS:CreationName="" DTS:DTSID="{PC-0005-0002}" DTS:From="Package\Truncate Fact_Sales" DTS:LogicalAnd="True" DTS:ObjectName="Truncate to Load" DTS:To="Package\Load Fact Sales" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Load to Count]" DTS:CreationName="" DTS:DTSID="{PC-0005-0003}" DTS:From="Package\Load Fact Sales" DTS:LogicalAnd="True" DTS:ObjectName="Load to Count" DTS:To="Package\Get Row Count" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Count to Log]" DTS:CreationName="" DTS:DTSID="{PC-0005-0004}" DTS:From="Package\Get Row Count" DTS:LogicalAnd="True" DTS:ObjectName="Count to Log" DTS:To="Package\Log Success" />
  </DTS:PrecedenceConstraints>
</DTS:Executable>

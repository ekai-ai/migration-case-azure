<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationName="Microsoft.Package"
  DTS:DTSID="{PKG06-AGG-0001}"
  DTS:ObjectName="06_Build_Aggregations"
  DTS:PackageType="5">
  <DTS:Property DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:ConnectionManagers>
    <DTS:ConnectionManager DTS:refId="Package.ConnectionManagers[NorthwindDW]" DTS:CreationName="OLEDB" DTS:DTSID="{CONN-DW-0006}" DTS:ObjectName="NorthwindDW">
      <DTS:ObjectData>
        <DTS:ConnectionManager DTS:ConnectionString="Data Source=localhost;Initial Catalog=Northwind;Provider=MSOLEDBSQL;Integrated Security=SSPI;" />
      </DTS:ObjectData>
    </DTS:ConnectionManager>
  </DTS:ConnectionManagers>
  <DTS:Variables />
  <DTS:Executables>
    <DTS:Executable DTS:refId="Package\Log Start" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOG-AGG1}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Log Start">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0006}" SQLTask:SqlStatementSource="INSERT INTO dbo.ETL_Log (PackageName, TaskName, StartTime, Status) VALUES ('06_Build_Aggregations', 'Build All', GETDATE(), 'Running')" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Build Sales By Category" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-AGG-CAT}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Build Sales By Category">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0006}" SQLTask:SqlStatementSource="
TRUNCATE TABLE dbo.Agg_SalesByCategory;
INSERT INTO dbo.Agg_SalesByCategory (
    Year, Quarter, Month, CategoryID, CategoryName, TotalQuantity,
    TotalGrossAmount, TotalDiscountAmount, TotalNetAmount, OrderCount,
    AvgUnitPrice, AvgDiscount, CategoryRankByRevenue, CategoryRankByQuantity
)
SELECT
    dd.Year,
    dd.Quarter,
    dd.Month,
    dp.CategoryID,
    dp.CategoryName,
    SUM(fs.Quantity) AS TotalQuantity,
    SUM(fs.GrossAmount) AS TotalGrossAmount,
    SUM(fs.DiscountAmount) AS TotalDiscountAmount,
    SUM(fs.NetAmount) AS TotalNetAmount,
    COUNT(DISTINCT fs.OrderID) AS OrderCount,
    AVG(fs.UnitPrice) AS AvgUnitPrice,
    AVG(fs.Discount) AS AvgDiscount,
    RANK() OVER (PARTITION BY dd.Year, dd.Quarter, dd.Month ORDER BY SUM(fs.NetAmount) DESC) AS CategoryRankByRevenue,
    RANK() OVER (PARTITION BY dd.Year, dd.Quarter, dd.Month ORDER BY SUM(fs.Quantity) DESC) AS CategoryRankByQuantity
FROM dbo.Fact_Sales fs
INNER JOIN dbo.Dim_Date dd ON fs.DateKey = dd.DateKey
INNER JOIN dbo.Dim_Product dp ON fs.ProductKey = dp.ProductKey
GROUP BY dd.Year, dd.Quarter, dd.Month, dp.CategoryID, dp.CategoryName;
" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Build Sales By Customer" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-AGG-CUS}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Build Sales By Customer">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0006}" SQLTask:SqlStatementSource="
TRUNCATE TABLE dbo.Agg_SalesByCustomer;
INSERT INTO dbo.Agg_SalesByCustomer (
    Year, CustomerKey, CustomerID, CompanyName, Country, TotalOrders,
    TotalQuantity, TotalNetAmount, TotalFreight, AvgOrderValue,
    AvgDaysToShip, UniqueProductsOrdered, UniqueCategoriesOrdered,
    CustomerRankByRevenue, CustomerRankByOrders
)
SELECT
    dd.Year,
    dc.CustomerKey,
    dc.CustomerID,
    dc.CompanyName,
    dc.Country,
    COUNT(DISTINCT fs.OrderID) AS TotalOrders,
    SUM(fs.Quantity) AS TotalQuantity,
    SUM(fs.NetAmount) AS TotalNetAmount,
    SUM(fs.FreightAllocation) AS TotalFreight,
    AVG(fs.NetAmount) AS AvgOrderValue,
    AVG(CAST(fs.DaysToShip AS DECIMAL(10,2))) AS AvgDaysToShip,
    COUNT(DISTINCT fs.ProductKey) AS UniqueProductsOrdered,
    COUNT(DISTINCT dp.CategoryID) AS UniqueCategoriesOrdered,
    RANK() OVER (PARTITION BY dd.Year ORDER BY SUM(fs.NetAmount) DESC) AS CustomerRankByRevenue,
    RANK() OVER (PARTITION BY dd.Year ORDER BY COUNT(DISTINCT fs.OrderID) DESC) AS CustomerRankByOrders
FROM dbo.Fact_Sales fs
INNER JOIN dbo.Dim_Date dd ON fs.DateKey = dd.DateKey
INNER JOIN dbo.Dim_Customer dc ON fs.CustomerKey = dc.CustomerKey
INNER JOIN dbo.Dim_Product dp ON fs.ProductKey = dp.ProductKey
GROUP BY dd.Year, dc.CustomerKey, dc.CustomerID, dc.CompanyName, dc.Country;
" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Build Employee Performance" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-AGG-EMP}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Build Employee Performance">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0006}" SQLTask:SqlStatementSource="
TRUNCATE TABLE dbo.Agg_EmployeePerformance;
INSERT INTO dbo.Agg_EmployeePerformance (
    Year, Quarter, EmployeeKey, EmployeeID, FullName, Title,
    TotalOrders, TotalCustomers, TotalNetAmount, TotalFreight,
    AvgOrderValue, LateShipmentCount, OnTimeDeliveryPct,
    EmployeeRankByRevenue, EmployeeRankByOrders
)
SELECT
    dd.Year,
    dd.Quarter,
    de.EmployeeKey,
    de.EmployeeID,
    de.FullName,
    de.Title,
    COUNT(DISTINCT fs.OrderID) AS TotalOrders,
    COUNT(DISTINCT fs.CustomerKey) AS TotalCustomers,
    SUM(fs.NetAmount) AS TotalNetAmount,
    SUM(fs.FreightAllocation) AS TotalFreight,
    AVG(fs.NetAmount) AS AvgOrderValue,
    SUM(CAST(fs.IsLateShipment AS INT)) AS LateShipmentCount,
    CAST(100.0 * SUM(CASE WHEN fs.IsLateShipment = 0 THEN 1 ELSE 0 END) / NULLIF(COUNT(*), 0) AS DECIMAL(5,2)) AS OnTimeDeliveryPct,
    RANK() OVER (PARTITION BY dd.Year, dd.Quarter ORDER BY SUM(fs.NetAmount) DESC) AS EmployeeRankByRevenue,
    RANK() OVER (PARTITION BY dd.Year, dd.Quarter ORDER BY COUNT(DISTINCT fs.OrderID) DESC) AS EmployeeRankByOrders
FROM dbo.Fact_Sales fs
INNER JOIN dbo.Dim_Date dd ON fs.DateKey = dd.DateKey
INNER JOIN dbo.Dim_Employee de ON fs.EmployeeKey = de.EmployeeKey
GROUP BY dd.Year, dd.Quarter, de.EmployeeKey, de.EmployeeID, de.FullName, de.Title;
" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable DTS:refId="Package\Log Success" DTS:CreationName="Microsoft.ExecuteSQLTask" DTS:DTSID="{EXEC-LOG-AGG2}" DTS:ExecutableType="Microsoft.ExecuteSQLTask" DTS:ObjectName="Log Success">
      <DTS:ObjectData>
        <SQLTask:SqlTaskData SQLTask:Connection="{CONN-DW-0006}" SQLTask:SqlStatementSource="UPDATE dbo.ETL_Log SET EndTime = GETDATE(), Status = 'Succeeded' WHERE PackageName = '06_Build_Aggregations' AND Status = 'Running'" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Log to Cat]" DTS:CreationName="" DTS:DTSID="{PC-0006-0001}" DTS:From="Package\Log Start" DTS:LogicalAnd="True" DTS:ObjectName="Log to Cat" DTS:To="Package\Build Sales By Category" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Cat to Cus]" DTS:CreationName="" DTS:DTSID="{PC-0006-0002}" DTS:From="Package\Build Sales By Category" DTS:LogicalAnd="True" DTS:ObjectName="Cat to Cus" DTS:To="Package\Build Sales By Customer" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Cus to Emp]" DTS:CreationName="" DTS:DTSID="{PC-0006-0003}" DTS:From="Package\Build Sales By Customer" DTS:LogicalAnd="True" DTS:ObjectName="Cus to Emp" DTS:To="Package\Build Employee Performance" />
    <DTS:PrecedenceConstraint DTS:refId="Package.PrecedenceConstraints[Emp to Log]" DTS:CreationName="" DTS:DTSID="{PC-0006-0004}" DTS:From="Package\Build Employee Performance" DTS:LogicalAnd="True" DTS:ObjectName="Emp to Log" DTS:To="Package\Log Success" />
  </DTS:PrecedenceConstraints>
</DTS:Executable>
